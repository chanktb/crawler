<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>TeeworksUSA Auto Run</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f6fa; margin:0; padding:20px; text-align:center; }
  h1 { font-size:22px; margin-bottom:20px; }
  .domains { grid-template-columns: 1fr 1fr; gap: 10px; max-width: 746px; margin: 0 auto 20px auto; align-items: start; }
  .col { display:flex; flex-direction:column; gap:10px; }
  #col2 { overflow-y: auto; }
  .domain { background:#fff; padding:10px 15px; border-radius:8px; border:1px solid #ddd;
    display:flex; justify-content:space-between; align-items:center; }
  button { padding:6px 12px; cursor:pointer; border:none; border-radius:5px; background:#2563eb; color:white; }
  button:hover { background:#1d4ed8; }
  #status { margin:15px 0; color:#555; font-style:italic; }
  .results { display:flex; flex-direction:column; gap:16px; align-items:center; }
  .product { background:#fff; border:1px solid #ddd; padding:12px; border-radius:10px; width:720px; text-align:center; }
  .product img { max-width:700px; height:auto; border-radius:8px; margin-bottom:8px; }
  .title { font-weight:bold; font-size:16px; }
  .url { font-size:14px; color:#2563eb; word-break:break-all; margin-top:6px; }
  #startUrl { width: 400px; padding:6px; border:1px solid #ccc; border-radius:6px; }
</style>
</head>
<body>
<h1><a href="/crawler/">DANH SÁCH TOOL</a></h1>
<h1><a href="javascript:location.reload()">TẢI LẠI TRANG</a></h1>
<h1>TeeworksUSA Auto Run</h1>

<div style="margin:20px 0;">
  <label>Nhập URL sản phẩm bắt đầu (ko bắt buộc):</label><br/>
  <input type="text" id="startUrl" placeholder="https://teeworksusa.com/product/...">
</div>

<div class="domains" id="domainList">
  <div class="col" id="col1"></div>
  <div class="col" id="col2"></div>
</div>

<div id="status">Chưa quét.</div>
<div id="results" class="results"></div>

<script>
const cfProxy = "https://cors-proxy.trantpu.workers.dev/?url=";
const scraperApiKey = "a81f3cb242118447359ed92553e82749";

const baseDomains = {
  "teeworksusa.com": { url: "https://teeworksusa.com/" }
};

function renderDomainList() {
  const col1 = document.getElementById("col1");
  col1.innerHTML = "";
  const div = document.createElement("div");
  div.className="domain";
  div.innerHTML=`<b>teeworksusa.com</b> <button onclick="showProducts('teeworksusa.com')">Show sản phẩm</button>`;
  col1.appendChild(div);
}
renderDomainList();

async function fetchSmart(url, index, domainKey) {
  const res = await fetch(cfProxy + encodeURIComponent(url));
  if (res.ok) return res;
  throw new Error("CF proxy lỗi " + res.status);
}

async function showProducts(domainKey) {
  const cfg = baseDomains[domainKey];
  document.getElementById("status").innerText = `Đang quét ${cfg.url}...`;
  document.getElementById("results").innerHTML = "";

  try {
    const list = await crawlSequential(domainKey, cfg.url, 100);
    render(list);
    document.getElementById("status").innerText = `Tìm thấy ${list.length} sản phẩm`;
  } catch(e) {
    document.getElementById("status").innerText="Lỗi: "+e.message;
  }
}

async function crawlSequential(domainKey, homeUrl, targetCount=100){
  const results=[]; const seen=new Set();
  let firstUrl;

  // Ưu tiên: nếu user nhập URL thì dùng luôn
  const userUrl = document.getElementById("startUrl").value.trim();
  if (userUrl) {
    firstUrl = userUrl;
  } else {
    // Nếu không nhập, dùng logic cũ
    if(domainKey==="teeworksusa.com"){
      const homeDoc=await fetchDocSmart(homeUrl,1,domainKey);
      const c=homeDoc.querySelector('.elementor-element.elementor-element-26e4f04');
      if(c){const a=c.querySelector('a[href*="/product/"]'); if(a) firstUrl=abs(a.getAttribute("href"),homeUrl);}
    }
  }

  if(!firstUrl) throw new Error("Không tìm thấy SP đầu tiên");
  let {meta,doc,url:curUrl}=await fetchProductMetaAndDocSmart(firstUrl,1,domainKey);
  if(meta){results.push(meta);seen.add(curUrl);render(results);}
  for(let i=2;i<=targetCount;i++){
    let nextUrl;
    if(domainKey==="teeworksusa.com"){
      const prevDiv=doc.querySelector("div.product-prev a[href*='/product/']");
      if(!prevDiv) break; nextUrl=abs(prevDiv.getAttribute("href"),curUrl);
    }
    if(!nextUrl||seen.has(nextUrl)) break;
    const next=await fetchProductMetaAndDocSmart(nextUrl,i,domainKey);
    if(!next.meta) break;
    results.push(next.meta); seen.add(next.url); curUrl=next.url; doc=next.doc;
    render(results); document.getElementById("status").innerText=`${domainKey}: ${results.length}/${targetCount}`;
  }
  return results;
}

async function fetchDocSmart(url,index,domainKey){
  const res=await fetchSmart(url,index,domainKey);
  const html=await res.text();
  return new DOMParser().parseFromString(html,"text/html");
}

async function fetchProductMetaAndDocSmart(url,index,domainKey){
  const res=await fetchSmart(url,index,domainKey);
  const html=await res.text();
  const doc=new DOMParser().parseFromString(html,"text/html");
  const title=doc.querySelector('meta[property="og:title"]')?.content
              ||doc.querySelector("h1")?.textContent?.trim()
              ||"";
  let img = "";

  if (domainKey === "teeworksusa.com") {
    // Thứ tự tìm ảnh
    const patterns = [
      /https?:\/\/[^"'\s>]*posters-black\.jpg/gi,
      /https?:\/\/[^"'\s>]*white-poster\.jpg/gi,
      /https?:\/\/[^"'\s>]*White-poster\.jpg/gi,
      /https?:\/\/[^"'\s>]*poster\.jpg/gi,
      /https?:\/\/[^"'\s>]*posters-white\.jpg/gi
    ];

    for (let regex of patterns) {
      const match = (html.match(regex) || [])[0];
      if (match) {
        img = match;
        break;
      }
    }

    // Fallback cuối cùng
    if (!img) {
      img = doc.querySelector('meta[property="og:image"]')?.content || "";
    }
  } else {
    img = doc.querySelector('meta[property="og:image"]')?.content || "";
  }

  return {meta:{title,img,url},doc,url};
}

function abs(url,base){try{return new URL(url,base).href;}catch{return url;}}
function render(list){
  const box=document.getElementById("results");box.innerHTML="";
  list.forEach((p,i)=>{
    const div=document.createElement("div");div.className="product";
    div.innerHTML=`<div><b>#${i+1}</b></div>${p.img?`<img src="${p.img}" />`:"(no image)"}<div class="title">${p.title}</div><div class="url">${p.url}</div>`;
    box.appendChild(div);
  });
}
</script>
</body>
</html>

