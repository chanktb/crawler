<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Crawler sản phẩm V3 (og:title / og:image)</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    input[type="text"], input[type="file"] { width: 100%; padding: 8px; margin: 5px 0; }
    button { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; }
    button:hover { background: #218838; }
    .product { margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
    img { max-width: 700px; display: block; }
    .number { font-weight: bold; margin-bottom: 5px; }
    #results { margin-top: 20px; }
    #status { color: blue; margin-top: 10px; }
</style>
</head>
<body>
<h1><a href="/crawler/">Danh sách tools</a></h1>
<h2>Crawl sản phẩm V3 (og:title / og:image)</h2>
<p>Sử dụng đối với site chặn các kiểu và không có mũi tên prev next</p>
<label>API ScraperAPI Key:</label>
<input type="text" id="apiKey" placeholder="Nhập API key ScraperAPI" value="a81f3cb242118447359ed92553e82749">

<label>API HEAD URL:</label>
<input type="text" id="apiHeadUrl" placeholder="Nhập API HEAD URL" value="https://head-api-vercel.vercel.app/api/api-head?url=">

<label>Chọn file sitemap XML:</label>
<input type="file" id="xmlFile" accept=".xml">

<button onclick="startCrawl()">Bắt đầu</button>
<div id="status"></div>

<p><b>hướng dẫn sử dụng:</b><br>
- đăng ký ScraperAPI để lấy key.<br>
- truy cập vào site cần crawl, lấy file sitemap.xml và tải về.<br>
- upload file sitemap.xml ở ô trên và bấm Bắt đầu.</p>

<div id="results"></div>

<script>
async function startCrawl() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const apiHead = document.getElementById('apiHeadUrl').value.trim();
    const fileInput = document.getElementById('xmlFile').files[0];
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    resultsEl.innerHTML = "";
    if (!apiKey || !apiHead || !fileInput) {
        alert("Vui lòng nhập đầy đủ API key, API HEAD URL và chọn file XML!");
        return;
    }

    statusEl.textContent = "Đang đọc sitemap...";
    const xmlText = await fileInput.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
    const locs = [...xmlDoc.getElementsByTagName("loc")].map(e => e.textContent.trim());
    const productUrls = locs.filter(url => url.includes("/product/"));
    
    if (productUrls.length === 0) {
        statusEl.textContent = "Không tìm thấy URL chứa /product/ trong sitemap.";
        return;
    }

    statusEl.textContent = "Đang lấy Last-Modified từ API HEAD...";
    const urlsWithDates = [];
    for (let url of productUrls) {
        try {
            const headRes = await fetch(apiHead + encodeURIComponent(url));
            const headJson = await headRes.json();
            urlsWithDates.push({ url, lastModified: new Date(headJson.lastModified || 0) });
        } catch {
            urlsWithDates.push({ url, lastModified: new Date(0) });
        }
    }

    urlsWithDates.sort((a, b) => b.lastModified - a.lastModified);
    const topUrls = urlsWithDates.slice(0, 100);

    statusEl.textContent = "Đang crawl sản phẩm...";
    let count = 0;
    for (let item of topUrls) {
        count++;
        try {
            const proxyUrl = `https://api.scraperapi.com?api_key=${apiKey}&url=${encodeURIComponent(item.url)}`;
            const res = await fetch(proxyUrl);
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, "text/html");
            const title = doc.querySelector('meta[property="og:title"]')?.content || "No title";
            const image = doc.querySelector('meta[property="og:image"]')?.content || "";
            const div = document.createElement("div");
            div.className = "product";
            div.innerHTML = `<div class="number">#${count}</div>
                             <img src="${image}" alt="${title}">
                             <div>${title}</div>`;
            resultsEl.appendChild(div);
        } catch {
            console.log("Lỗi khi crawl:", item.url);
        }
    }
    statusEl.textContent = "Hoàn thành!";
}
</script>

</body>
</html>
