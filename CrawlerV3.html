<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Crawler sản phẩm V3 (lọc lastmod trước)</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px 0; padding: 5px; }
    img { max-width: 700px; display: block; margin: 10px 0; }
    .product { margin-bottom: 30px; }
    .number { font-weight: bold; margin-bottom: 5px; }
    #results { margin-top: 20px; }
</style>
</head>
<body>

<h2>Crawl sản phẩm V3 (lọc lastmod trước)</h2>
<p>Sử dụng đối với site chặn json và không có mũi tên prev next</p>
<p>Hướng dẫn:</p>
<ol>
<li>Đăng ký ScraperAPI để lấy API Key: <a href="https://www.scraperapi.com/" target="_blank">scraperapi.com</a></li>
<li>Nhập API key hoặc dùng key mặc định.</li>
<li>Upload file XML sitemap.</li>
<li>Tool sẽ lọc URL chứa <code>/product/</code> và <code>&lt;lastmod&gt;</code> trong vòng 1 ngày, sau đó crawl tiêu đề và ảnh.</li>
</ol>

<label>ScraperAPI Key:</label><br>
<input type="text" id="apiKey" value="a81f3cb242118447359ed92553e82749" style="width:400px"><br>

<label>API HEAD URL:</label><br>
<input type="text" id="apiHeadUrl" value="https://head-api-vercel.vercel.app/api/api-head?url=" style="width:400px"><br>

<input type="file" id="xmlFile" accept=".xml"><br>
<button onclick="startCrawl()">Bắt đầu</button>
<span id="status"></span>

<div id="results"></div>

<script>
async function startCrawl() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const apiHeadUrl = document.getElementById('apiHeadUrl').value.trim();
    const fileInput = document.getElementById('xmlFile').files[0];

    if (!fileInput) { alert("Vui lòng upload file XML!"); return; }

    document.getElementById('status').textContent = "Đang chạy...";

    const xmlText = await fileInput.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");

    const now = new Date();
    const oneDayMs = 24 * 60 * 60 * 1000;
    const locElements = xmlDoc.getElementsByTagName("url");
    let productUrls = [];

    for (let i = 0; i < locElements.length; i++) {
        const loc = locElements[i].getElementsByTagName("loc")[0]?.textContent.trim();
        const lastmodStr = locElements[i].getElementsByTagName("lastmod")[0]?.textContent.trim();
        if (!loc || !loc.includes("/product/")) continue;
        if (lastmodStr) {
            const lastmodDate = new Date(lastmodStr);
            if (Math.abs(now - lastmodDate) <= oneDayMs) {
                productUrls.push({ url: loc, lastmodXml: lastmodDate });
            }
        }
    }

    // HEAD request để lấy Last-Modified chuẩn
    for (let item of productUrls) {
        try {
            const headResp = await fetch(apiHeadUrl + encodeURIComponent(item.url));
            const headData = await headResp.json();
            item.lastModified = headData.lastModified ? new Date(headData.lastModified) : item.lastmodXml;
        } catch {
            item.lastModified = item.lastmodXml;
        }
    }

    // Sắp xếp mới nhất → cũ nhất
    productUrls.sort((a, b) => b.lastModified - a.lastModified);
    const topUrls = productUrls.slice(0, 100);

    // Crawl từng URL
    let resultsHtml = "";
    let count = 1;
    for (let item of topUrls) {
        try {
            const resp = await fetch(`https://api.scraperapi.com?api_key=${apiKey}&url=${encodeURIComponent(item.url)}`);
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, "text/html");

            const title = doc.querySelector('meta[property="og:title"]')?.content || "No title";
            const image = doc.querySelector('meta[property="og:image"]')?.content || "";

            resultsHtml += `<div class="product">
                <div class="number">#${count}</div>
                ${image ? `<img src="${image}" alt="">` : ""}
                <div>${title}</div>
            </div>`;
            count++;
            document.getElementById('results').innerHTML = resultsHtml;
        } catch (e) {
            console.error("Error crawling:", e);
        }
    }

    document.getElementById('status').textContent = "Hoàn tất!";
}
</script>

</body>
</html>

